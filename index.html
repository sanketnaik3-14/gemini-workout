<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Fitness & Nutrition Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Your Fitness Dashboard</h1>
            <p class="text-lg text-gray-600 mt-2">A personalized plan for your success.</p>
        </header>

        <!-- Tabs Navigation -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                <button onclick="changeTab('dashboard')" class="tab-button active w-1/2 md:w-auto text-center md:text-left py-4 px-1 border-b-2 font-medium text-sm md:text-base">
                    Dashboard & Calculator
                </button>
                <button onclick="changeTab('tracker')" class="tab-button w-1/2 md:w-auto text-center md:text-left py-4 px-1 border-b-2 font-medium text-sm md:text-base">
                    Weigh-In Tracker
                </button>
                <button onclick="changeTab('diet')" class="tab-button w-1/2 md:w-auto text-center md:text-left py-4 px-1 border-b-2 font-medium text-sm md:text-base">
                    Diet Plan
                </button>
                <button onclick="changeTab('exercise')" class="tab-button w-1/2 md:w-auto text-center md:text-left py-4 px-1 border-b-2 font-medium text-sm md:text-base">
                    Exercise Plan
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Calculator Card -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Calorie & Macro Calculator</h2>
                    <form id="calculator-form" class="space-y-4">
                        <div>
                            <label for="weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                            <input type="number" id="weight" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-700">Height (cm)</label>
                            <input type="number" id="height" value="168" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="age" class="block text-sm font-medium text-gray-700">Age</label>
                            <input type="number" id="age" value="35" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="bodyfat" class="block text-sm font-medium text-gray-700">Body Fat %</label>
                            <input type="number" id="bodyfat" value="36.3" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="activity" class="block text-sm font-medium text-gray-700">Activity Level</label>
                            <select id="activity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                <option value="1.2">Sedentary (desk job)</option>
                                <option value="1.375" selected>Lightly Active (Sedentary job + 1-3 workouts/week)</option>
                                <option value="1.55">Moderately Active (Sedentary job + 3-5 workouts/week)</option>
                                <option value="1.725">Very Active (Physical job or hard exercise 6-7 days/week)</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">Calculate</button>
                    </form>
                </div>
                <!-- Results Card -->
                <div id="results-card" class="bg-white p-6 rounded-lg shadow-sm space-y-4">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Your Targets</h2>
                    <div class="p-4 bg-indigo-50 rounded-lg">
                        <h3 class="font-semibold text-indigo-800">Maintenance Calories (TDEE)</h3>
                        <p id="tdee-result" class="text-2xl font-bold text-indigo-900">0 kcal</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h3 class="font-semibold text-green-800">Target for Fat Loss (-500 kcal)</h3>
                        <p id="target-result" class="text-2xl font-bold text-green-900">0 kcal</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">Recommended Daily Macros</h3>
                        <div class="space-y-2">
                            <p><strong>Protein:</strong> <span id="protein-result">0g</span></p>
                            <p><strong>Carbohydrates:</strong> <span id="carbs-result">0g</span></p>
                            <p><strong>Fats:</strong> <span id="fats-result">0g</span></p>
                        </div>
                    </div>
                </div>
            </div>
             <!-- Ingredient Customization -->
            <div class="bg-white p-6 rounded-lg shadow-sm mt-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-900">Ingredient Customizer</h2>
                <p class="text-sm text-gray-600 mb-4">Update the macros for your brown rice if you use a different brand. Values are per 100g dry.</p>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="rice-protein" class="block text-sm font-medium text-gray-700">Rice Protein (g)</label>
                        <input type="number" id="rice-protein" value="9" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="rice-carbs" class="block text-sm font-medium text-gray-700">Rice Carbs (g)</label>
                        <input type="number" id="rice-carbs" value="76" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <div>
                        <label for="rice-fat" class="block text-sm font-medium text-gray-700">Rice Fat (g)</label>
                        <input type="number" id="rice-fat" value="2.3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>
                    <button id="save-ingredients-btn" class="self-end bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">Save Changes</button>
                </div>
                 <div id="ingredient-save-status" class="mt-2 text-sm text-green-600"></div>
            </div>
        </div>

        <div id="tracker" class="tab-content hidden">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Weigh-in Form Card -->
                 <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Log Your Weekly Weigh-In</h2>
                    <form id="weigh-in-form" class="space-y-4">
                        <div>
                            <label for="weigh-in-date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="weigh-in-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <div>
                            <label for="weigh-in-weight" class="block text-sm font-medium text-gray-700">Weight (kg)</label>
                            <input type="number" id="weigh-in-weight" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">Add Weigh-In</button>
                    </form>
                     <div id="weigh-in-status" class="mt-2 text-sm text-green-600"></div>
                </div>
                <!-- Weigh-in History Card -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h2 class="text-2xl font-bold mb-4 text-gray-900">Your Progress</h2>
                    <div style="height: 300px;">
                        <canvas id="weighInChart"></canvas>
                    </div>
                </div>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-sm mt-8">
                 <h2 class="text-2xl font-bold mb-4 text-gray-900">Weigh-In History</h2>
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (kg)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="weigh-in-history" class="bg-white divide-y divide-gray-200">
                            <!-- History will be populated by JS -->
                        </tbody>
                    </table>
                </div>
             </div>
        </div>

        <div id="diet" class="tab-content hidden bg-white p-6 rounded-lg shadow-sm">
             <h2 class="text-2xl font-bold mb-4 text-gray-900">Finalized Diet & Prep Plan</h2>
             <div class="space-y-6 text-gray-700">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Daily Meal Structure</h3>
                     <ul class="list-disc list-inside space-y-1">
                        <li>**Breakfast:** 5 Scrambled Eggs + a portion of Brown Rice</li>
                        <li>**Lunch:** Chicken (125g) + a portion of Brown Rice</li>
                        <li>**Dinner:** Chicken (125g) + a portion of Brown Rice</li>
                        <li>**Snacks:** 2 Protein Shakes (mixed with water)</li>
                     </ul>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Final Daily Targets (~1960 kcal)</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-3 rounded-lg"><span class="font-bold">Protein:</span> ~180g</div>
                        <div class="bg-yellow-50 p-3 rounded-lg"><span class="font-bold">Carbs:</span> ~177g</div>
                        <div class="bg-red-50 p-3 rounded-lg"><span class="font-bold">Fat:</span> ~59g</div>
                    </div>
                </div>
                 <div>
                    <h3 class="text-xl font-semibold mb-2">4-Day Bulk Prep Guide</h3>
                     <p>Follow these steps once every four days.</p>
                     <h4 class="font-semibold mt-4">Shopping List:</h4>
                     <ul class="list-disc list-inside space-y-1">
                        <li>Chicken Breast: **1.0 kg**</li>
                        <li>Eggs: **20**</li>
                        <li>Brown Rice (Dry): **920g**</li>
                        <li>Protein Powder: **8 servings**</li>
                        <li>Cooking Oil: **70 ml** (60ml for chicken, 10ml for eggs)</li>
                    </ul>
                     <h4 class="font-semibold mt-4">Cooking & Portioning (12 Containers):</h4>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>**Cook Foods:** Saut√© the chicken, scramble the eggs, and cook the brown rice.</li>
                        <li>**Portion Breakfast:** Divide the 20 scrambled eggs equally among 4 containers.</li>
                        <li>**Portion Lunch/Dinner:** Divide the cooked chicken equally among the remaining 8 containers.</li>
                        <li>**Portion Rice:** Divide all the cooked rice equally among **all 12 containers**.</li>
                        <li>**Store:** Seal and refrigerate.</li>
                    </ol>
                </div>
            </div>
        </div>

        <div id="exercise" class="tab-content hidden bg-white p-6 rounded-lg shadow-sm">
             <h2 class="text-2xl font-bold mb-4 text-gray-900">Your Home Workout Plan</h2>
             
             <div class="space-y-8">
                 <!-- Principles -->
                 <div>
                    <h3 class="text-xl font-semibold mb-3 text-indigo-700 border-b pb-2">Key Principles for Success</h3>
                    <ul class="list-disc list-inside space-y-2 mt-2 text-gray-600">
                        <li>**Schedule:** Workout A (Mon), Workout B (Wed), Workout C (Fri).</li>
                        <li>**Sets & Reps:** Aim for 3-4 sets of 8-15 reps for each exercise.</li>
                        <li>**Rest:** 60-90 seconds between sets, 90-120 seconds between exercises.</li>
                        <li>**Progressive Overload:** Crucial for growth. Each week, try to add a rep, a set, or slow down the movement.</li>
                    </ul>
                 </div>

                 <!-- Warm-Up -->
                 <div>
                    <h3 class="text-xl font-semibold mb-3 text-indigo-700 border-b pb-2">Warm-Up (Before Every Workout)</h3>
                     <ul class="list-disc list-inside space-y-1 mt-2 text-gray-600">
                        <li>**Jumping Jacks:** 60 seconds</li>
                        <li>**Arm Circles:** 30 seconds forward & backward</li>
                        <li>**Bodyweight Squats:** 15-20 reps</li>
                     </ul>
                 </div>

                 <!-- Workout A -->
                 <div class="space-y-4">
                     <h3 class="text-xl font-bold text-gray-800">Workout A</h3>
                     <div class="table-responsive">
                         <table class="min-w-full">
                             <thead class="bg-gray-100">
                                 <tr>
                                     <th class="px-4 py-2 text-left">Exercise</th>
                                     <th class="px-4 py-2 text-left">Sets & Reps</th>
                                     <th class="px-4 py-2 text-left">Notes</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Goblet Squats</td>
                                     <td class="px-4 py-2">4 x 10-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Hold one 5kg dumbbell vertically at your chest.</td>
                                 </tr>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Push-Ups</td>
                                     <td class="px-4 py-2">4 x To Failure</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Option: Add red band across back for more resistance.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Bent-Over Rows</td>
                                     <td class="px-4 py-2">4 x 10-15 (per arm)</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Hinge at hips with a flat back.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Overhead Press</td>
                                     <td class="px-4 py-2">3 x 10-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Press from shoulders to overhead.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Bicep Curls</td>
                                     <td class="px-4 py-2">3 x 10-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Keep elbows locked at your sides.</td>
                                 </tr>
                                 <tr>
                                     <td class="px-4 py-2 font-medium">Plank</td>
                                     <td class="px-4 py-2">3 x Max Hold</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Maintain a straight line from head to heels.</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>

                 <!-- Workout B -->
                 <div class="space-y-4">
                     <h3 class="text-xl font-bold text-gray-800">Workout B</h3>
                     <div class="table-responsive">
                         <table class="min-w-full">
                             <thead class="bg-gray-100">
                                 <tr>
                                     <th class="px-4 py-2 text-left">Exercise</th>
                                     <th class="px-4 py-2 text-left">Sets & Reps</th>
                                     <th class="px-4 py-2 text-left">Notes</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Lunges</td>
                                     <td class="px-4 py-2">3 x 10-12 (per leg)</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Hold both 5kg dumbbells.</td>
                                 </tr>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Floor Press</td>
                                     <td class="px-4 py-2">4 x 10-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Lie on back, press dumbbells from chest up.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Band Pull-Aparts</td>
                                     <td class="px-4 py-2">3 x 15-20</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Squeeze shoulder blades together.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell Lateral Raises</td>
                                     <td class="px-4 py-2">3 x 12-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Raise dumbbells to shoulder height.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Tricep Dips</td>
                                     <td class="px-4 py-2">3 x To Failure</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Use a sturdy chair or bed edge.</td>
                                 </tr>
                                 <tr>
                                     <td class="px-4 py-2 font-medium">Leg Raises</td>
                                     <td class="px-4 py-2">3 x 15-20</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Lie on back, lower legs slowly.</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>

                 <!-- Workout C -->
                 <div class="space-y-4">
                     <h3 class="text-xl font-bold text-gray-800">Workout C</h3>
                     <div class="table-responsive">
                         <table class="min-w-full">
                             <thead class="bg-gray-100">
                                 <tr>
                                     <th class="px-4 py-2 text-left">Exercise</th>
                                     <th class="px-4 py-2 text-left">Sets & Reps</th>
                                     <th class="px-4 py-2 text-left">Notes</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Dumbbell RDLs</td>
                                     <td class="px-4 py-2">4 x 12-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Hinge at hips, keep back flat.</td>
                                 </tr>
                                 <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Decline Push-Ups</td>
                                     <td class="px-4 py-2">4 x To Failure</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Elevate feet on a chair to target upper chest.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Band Bent-Over Rows</td>
                                     <td class="px-4 py-2">4 x 12-15</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Stand on the band and row.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Band Face Pulls</td>
                                     <td class="px-4 py-2">3 x 15-20</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Anchor band at chest height, pull to face.</td>
                                 </tr>
                                  <tr class="border-b">
                                     <td class="px-4 py-2 font-medium">Band Bicep Curls</td>
                                     <td class="px-4 py-2">3 x 15-20</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">Stand on the band and curl up.</td>
                                 </tr>
                                 <tr>
                                     <td class="px-4 py-2 font-medium">Plank with Shoulder Taps</td>
                                     <td class="px-4 py-2">3 x 20-30 total</td>
                                     <td class="px-4 py-2 text-sm text-gray-600">In a high plank, tap opposite shoulders.</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                 </div>
                 
                 <!-- Cool-Down -->
                 <div>
                    <h3 class="text-xl font-semibold mb-3 text-indigo-700 border-b pb-2">Cool-Down (After Every Workout)</h3>
                     <ul class="list-disc list-inside space-y-1 mt-2 text-gray-600">
                        <li>**Quad Stretch:** 30 seconds per side</li>
                        <li>**Hamstring Stretch:** 30 seconds per side</li>
                        <li>**Chest Stretch:** 30 seconds</li>
                        <li>**Child's Pose:** 60 seconds</li>
                     </ul>
                 </div>
             </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-fitness-app';
        let db, auth, userId, weighInUnsubscribe = null, ingredientUnsubscribe = null;
        let weighInChart = null;

        // --- INITIALIZATION ---
        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');

                await authenticateUser();
                
                // Add event listeners after authentication
                document.getElementById('calculator-form').addEventListener('submit', handleCalculation);
                document.getElementById('weigh-in-form').addEventListener('submit', addWeighIn);
                document.getElementById('save-ingredients-btn').addEventListener('click', saveIngredients);


                // Initial calculation on load
                calculate();
            } catch (error) {
                console.error("Initialization Error:", error);
                // Display error to user if needed
            }
        }

        async function authenticateUser() {
             onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated with UID:", userId);
                    await setupListeners();
                } else {
                    console.log("No user signed in, trying custom token or anonymous sign-in.");
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                    }
                }
            });
        }
        
        async function setupListeners() {
            if (!userId) return;
            // Setup Firestore listeners for real-time updates
            setupWeighInListener();
            setupIngredientListener();
        }

        // --- UI & TAB LOGIC ---
        window.changeTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="changeTab('${tabName}')"]`).classList.add('active');
        };

        // --- CALCULATOR LOGIC ---
        function handleCalculation(e) {
            e.preventDefault();
            calculate();
        }

        function calculate() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseFloat(document.getElementById('age').value);
            const bodyfat = parseFloat(document.getElementById('bodyfat').value);
            const activityMultiplier = parseFloat(document.getElementById('activity').value);

            if (isNaN(weight) || isNaN(height) || isNaN(age) || isNaN(bodyfat)) {
                alert("Please fill in all fields with valid numbers.");
                return;
            }

            const leanBodyMass = weight * (1 - (bodyfat / 100));
            const bmr = 370 + (21.6 * leanBodyMass); // Katch-McArdle Formula
            const tdee = bmr * activityMultiplier;
            const targetCalories = tdee - 500;

            document.getElementById('tdee-result').textContent = `${Math.round(tdee)} kcal`;
            document.getElementById('target-result').textContent = `${Math.round(targetCalories)} kcal`;

            // Calculate Macros based on a 1960 kcal target for consistency with the plan
            const proteinGrams = 1.8 * weight; // 1.8 g/kg
            const proteinCalories = proteinGrams * 4;
            const fatCalories = targetCalories * 0.25; // 25% of calories from fat
            const fatGrams = fatCalories / 9;
            const carbCalories = targetCalories - proteinCalories - fatCalories;
            const carbGrams = carbCalories / 4;

            document.getElementById('protein-result').textContent = `${Math.round(proteinGrams)}g`;
            document.getElementById('carbs-result').textContent = `${Math.round(carbGrams)}g`;
            document.getElementById('fats-result').textContent = `${Math.round(fatGrams)}g`;
        }

        // --- WEIGH-IN TRACKER (FIRESTORE) ---
         function setupWeighInListener() {
            if (!userId || !db) return;
            const weighInCollectionPath = `artifacts/${appId}/users/${userId}/weigh-ins`;
            const q = query(collection(db, weighInCollectionPath), orderBy("date", "asc"));
            
            if (weighInUnsubscribe) weighInUnsubscribe(); // Detach old listener

            weighInUnsubscribe = onSnapshot(q, (querySnapshot) => {
                const weighIns = [];
                querySnapshot.forEach((doc) => {
                    weighIns.push({ id: doc.id, ...doc.data() });
                });
                renderWeighInHistory(weighIns);
                renderChart(weighIns);
            }, (error) => {
                console.error("Error listening to weigh-ins:", error);
            });
        }


        async function addWeighIn(e) {
            e.preventDefault();
            const date = document.getElementById('weigh-in-date').value;
            const weight = parseFloat(document.getElementById('weigh-in-weight').value);
            const statusEl = document.getElementById('weigh-in-status');
            
            if (!date || isNaN(weight)) {
                statusEl.textContent = 'Please enter a valid date and weight.';
                statusEl.className = 'mt-2 text-sm text-red-600';
                return;
            }
            
            const weighInCollectionPath = `artifacts/${appId}/users/${userId}/weigh-ins`;
            
            try {
                await addDoc(collection(db, weighInCollectionPath), { date, weight });
                statusEl.textContent = 'Weigh-in added successfully!';
                statusEl.className = 'mt-2 text-sm text-green-600';
                e.target.reset(); // Clear form
                setTimeout(() => statusEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error adding weigh-in: ", error);
                statusEl.textContent = 'Error adding weigh-in.';
                statusEl.className = 'mt-2 text-sm text-red-600';
            }
        }
        
        function renderWeighInHistory(weighIns) {
            const historyBody = document.getElementById('weigh-in-history');
            historyBody.innerHTML = '';
            weighIns.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${item.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${item.weight} kg</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="text-red-600 hover:text-red-900" data-id="${item.id}">Delete</button>
                    </td>
                `;
                row.querySelector('button').addEventListener('click', () => deleteWeighIn(item.id));
                historyBody.appendChild(row);
            });
        }

        async function deleteWeighIn(docId) {
            if(confirm("Are you sure you want to delete this weigh-in?")) {
                try {
                    const weighInDocPath = `artifacts/${appId}/users/${userId}/weigh-ins/${docId}`;
                    await deleteDoc(doc(db, weighInDocPath));
                    console.log("Document successfully deleted!");
                } catch (error) {
                    console.error("Error removing document: ", error);
                }
            }
        }
        
        // --- CHART.JS LOGIC ---
        function renderChart(data) {
            const ctx = document.getElementById('weighInChart').getContext('2d');
            const labels = data.map(item => item.date);
            const weights = data.map(item => item.weight);

            if (weighInChart) {
                weighInChart.destroy();
            }

            weighInChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight (kg)',
                        data: weights,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
        
        // --- INGREDIENT CUSTOMIZER (FIRESTORE) ---
        function setupIngredientListener() {
            if (!userId || !db) return;
            const ingredientDocPath = `artifacts/${appId}/users/${userId}/ingredients/rice`;
            if (ingredientUnsubscribe) ingredientUnsubscribe(); // Detach old listener
            
            ingredientUnsubscribe = onSnapshot(doc(db, ingredientDocPath), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('rice-protein').value = data.protein || 9;
                    document.getElementById('rice-carbs').value = data.carbs || 76;
                    document.getElementById('rice-fat').value = data.fat || 2.3;
                    console.log("Loaded custom ingredient data.");
                } else {
                    console.log("No custom ingredient data found, using defaults.");
                }
            }, (error) => {
                console.error("Error listening to ingredients:", error);
            });
        }

        async function saveIngredients(e) {
            e.preventDefault();
            const statusEl = document.getElementById('ingredient-save-status');
            const riceMacros = {
                protein: parseFloat(document.getElementById('rice-protein').value),
                carbs: parseFloat(document.getElementById('rice-carbs').value),
                fat: parseFloat(document.getElementById('rice-fat').value)
            };

            const ingredientDocRef = doc(db, `artifacts/${appId}/users/${userId}/ingredients`, 'rice');

            try {
                await setDoc(ingredientDocRef, riceMacros);
                statusEl.textContent = 'Ingredient macros saved!';
                setTimeout(() => statusEl.textContent = '', 3000);
            } catch (error) {
                console.error("Error saving ingredients: ", error);
                statusEl.textContent = 'Error saving macros.';
            }
        }

        // --- RUN APP ---
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
